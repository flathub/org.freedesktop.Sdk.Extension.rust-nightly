id: org.freedesktop.Sdk.Extension.rust-nightly
branch: '23.08'
runtime: org.freedesktop.Sdk
build-extension: true
sdk: org.freedesktop.Sdk
runtime-version: '23.08'
separate-locales: false

modules:

  - name: rust
    buildsystem: simple
    build-commands:
      - install -Dm0644 ${FLATPAK_ID}.appdata.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
      - install -Dm0755 apply_extra ${FLATPAK_DEST}/bin/apply_extra
    sources:
      - type: extra-data
        only-arches:
          - aarch64
        url: https://static.rust-lang.org/dist/2024-08-11/rust-nightly-aarch64-unknown-linux-gnu.tar.xz
        sha256: e36319b63cd8c06bb8e34fcd69f882db8b15b9fa12eac4943323fdbead287dfb
        filename: rust-nightly.tar.xz
        size: 242302484
      - type: extra-data
        only-arches:
          - x86_64
        url: https://static.rust-lang.org/dist/2024-08-11/rust-nightly-x86_64-unknown-linux-gnu.tar.xz
        sha256: 52443779ef053dee73a8730ef6c55b4c705673d7e9ecdb32329f024a2708b5cf
        filename: rust-nightly.tar.xz
        size: 183205064
      - type: extra-data
        url: https://static.rust-lang.org/dist/2024-08-11/rust-src-nightly.tar.xz
        sha256: 4c63de386d9220fffc2557bcb5e9cc23736ed55860c8dcb44b013c5b2b06daf7
        filename: rust-src-nightly.tar.xz
        size: 2954468
      - type: extra-data
        only-arches:
          - x86_64
        url: https://github.com/rui314/mold/releases/download/v2.33.0/mold-2.33.0-x86_64-linux.tar.gz
        sha256: e169f7aaec6fbbad5e02ce8d705f59ed9372179ea180afb3fc967c3941ab2c16
        filename: mold-linux.tar.gz
        size: 8571923
        x-checker-data:
          type: anitya
          project-id: 241732
          stable-only: true
          url-template: https://github.com/rui314/mold/releases/download/v$version/mold-$version-x86_64-linux.tar.gz
      - type: extra-data
        only-arches:
          - aarch64
        url: https://github.com/rui314/mold/releases/download/v2.33.0/mold-2.33.0-aarch64-linux.tar.gz
        sha256: 20ba9736a3dc0e0c9d5df177f375ad9c9d2a88864727e80a3e21d71abc7874e4
        filename: mold-linux.tar.gz
        size: 8557849
        x-checker-data:
          type: anitya
          project-id: 241732
          stable-only: true
          url-template: https://github.com/rui314/mold/releases/download/v$version/mold-$version-aarch64-linux.tar.gz
      - type: extra-data
        only-arches:
          - x86_64
        url: https://github.com/rust-lang/rust-analyzer/releases/download/2024-08-12/rust-analyzer-x86_64-unknown-linux-gnu.gz
        sha256: 14347c9fc6faeae1ff26d08495f319581603c4ce39e85f7ae16f1316d65a6e44
        filename: rust-analyzer.gz
        size: 14663514
        x-checker-data:
          type: json
          url: https://api.github.com/repos/rust-analyzer/rust-analyzer/releases/latest
          version-query: .tag_name
          url-query: .assets[] | select(.name=="rust-analyzer-x86_64-unknown-linux-gnu.gz")
            | .browser_download_url
      - type: extra-data
        only-arches:
          - aarch64
        url: https://github.com/rust-lang/rust-analyzer/releases/download/2024-08-12/rust-analyzer-aarch64-unknown-linux-gnu.gz
        sha256: 25e82a7a7656a4cee7af618ea8d3ec4d99f281ec1563cd834af706a58543621b
        filename: rust-analyzer.gz
        size: 14630195
        x-checker-data:
          type: json
          url: https://api.github.com/repos/rust-analyzer/rust-analyzer/releases/latest
          version-query: .tag_name
          url-query: .assets[] | select(.name=="rust-analyzer-aarch64-unknown-linux-gnu.gz")
            | .browser_download_url
      - type: file
        path: org.freedesktop.Sdk.Extension.rust-nightly.appdata.xml
      - type: script
        commands:
          - mkdir -p rust-nightly && tar -xf rust-nightly.tar.xz --strip=1 -C rust-nightly
          - mkdir -p rust-src-nightly && tar -xf rust-src-nightly.tar.xz --strip=1
            -C rust-src-nightly
          - mkdir -p mold && tar -xf mold-linux.tar.gz --strip=1 -C mold
          - gunzip rust-analyzer.gz
          - ./rust-nightly/install.sh --prefix=/app/extra/sdk/rust-nightly --without=rust-docs
            --without=rust-docs-json-preview --disable-ldconfig > /dev/null
          - ./rust-src-nightly/install.sh --prefix=/app/extra/sdk/rust-nightly --disable-ldconfig
            > /dev/null
          - install -Dm0755 mold/bin/mold -t /app/extra/sdk/rust-nightly/bin
          - install -Dm0755 rust-analyzer -t /app/extra/sdk/rust-nightly/bin
          - rm -rf rust-nightly.tar.xz rust-src-nightly.tar.xz mold-linux.tar.gz rust-analyzer.gz
            rust-analyzer mold rust-src-nightly rust-nightly sdk/rust-nightly/etc
            sdk/rust-nightly/share
        dest-filename: apply_extra
